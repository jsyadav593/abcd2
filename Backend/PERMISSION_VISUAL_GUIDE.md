# Permission System - Visual Reference

## ğŸ¯ Complete Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER MAKES REQUEST                           â”‚
â”‚              POST /api/users {"name": "John"}                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            MIDDLEWARE 1: Verify JWT (auth.middleware)           â”‚
â”‚                                                                   â”‚
â”‚  Check: Is user logged in?                                      â”‚
â”‚  â”œâ”€ If NO  â†’ 401 Unauthorized                                   â”‚
â”‚  â””â”€ If YES â†’ Set req.user = user data, Continue                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    MIDDLEWARE 2: Permission Check (permission.middleware)       â”‚
â”‚                                                                   â”‚
â”‚  authorize('USER_CREATE')                                       â”‚
â”‚                                                                   â”‚
â”‚  Step 1: Get user's roleId from req.user                        â”‚
â”‚  Step 2: Find Role with that roleId                             â”‚
â”‚  Step 3: Check if 'USER_CREATE' is in role.permissions          â”‚
â”‚                                                                   â”‚
â”‚  â”œâ”€ If NO  â†’ 403 Forbidden                                      â”‚
â”‚  â”‚           "You don't have permission..."                     â”‚
â”‚  â”‚                                                               â”‚
â”‚  â””â”€ If YES â†’ Set req.userRole = role data, Continue             â”‚
â”‚              to controller                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CONTROLLER: Create User                          â”‚
â”‚                                                                   â”‚
â”‚  Now we KNOW user has permission to create user                 â”‚
â”‚  Additional checks:                                             â”‚
â”‚  â”œâ”€ Can they create this role level?                            â”‚
â”‚  â”œâ”€ Do scope restrictions apply?                                â”‚
â”‚  â””â”€ Validate business logic                                     â”‚
â”‚                                                                   â”‚
â”‚  if (all good) {                                                â”‚
â”‚    Create user in database                                      â”‚
â”‚    Return 201 Created âœ…                                        â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¥ Role Hierarchy (à¤Ÿà¥‡à¤•à¥à¤¨à¥€à¤•à¤²à¥€ Level)

```
                    Level 5
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Enterprise   â”‚
              â”‚   Admin      â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Can create roles level 1-4
                     â”‚
                    Level 4
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Super       â”‚
              â”‚  Admin       â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Can create roles level 1-3
                     â”‚
                    Level 3
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Admin      â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Can create roles level 1-2
                     â”‚
                    Level 2
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Branch Admin â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Can assign but not create roles
                     â”‚
                    Level 1
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    User      â”‚
              â”‚ (No creation)â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Permission Inheritance (Data-wise)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     PERMISSION Model               â”‚
â”‚  (20+ permissions exist)            â”‚
â”‚                                     â”‚
â”‚  USER_CREATE                        â”‚
â”‚  USER_READ                          â”‚
â”‚  USER_UPDATE                        â”‚
â”‚  USER_DELETE                        â”‚
â”‚  ASSET_ASSIGN                       â”‚
â”‚  REPORT_GENERATE                    â”‚
â”‚  ... etc                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                â–²
         â”‚                â”‚
    Uses â”‚                â”‚ Uses
         â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ROLE Model (5 roles)            â”‚
â”‚                                     â”‚
â”‚ Enterprise Admin                    â”‚
â”‚  â”œâ”€ permissions: [USER_CREATE,      â”‚
â”‚  â”‚                USER_DELETE,      â”‚
â”‚  â”‚                ASSET_ASSIGN,     â”‚
â”‚  â”‚                SETTINGS_MANAGE]  â”‚
â”‚  â””â”€ level: 5                        â”‚
â”‚                                     â”‚
â”‚ Super Admin                         â”‚
â”‚  â”œâ”€ permissions: [USER_CREATE,      â”‚
â”‚  â”‚                ASSET_ASSIGN,     â”‚
â”‚  â”‚                REPORT_GENERATE]  â”‚
â”‚  â””â”€ level: 4                        â”‚
â”‚                                     â”‚
â”‚ ... etc                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²
         â”‚
    Has â”‚
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     USER Model                      â”‚
â”‚                                     â”‚
â”‚ name: "John"                        â”‚
â”‚ email: "john@example.com"           â”‚
â”‚ roleId: 507f1f77bcf86cd799439011   â”‚â™¦â”€â†’ Points to Role
â”‚         (Enterprise Admin Role)     â”‚
â”‚ organizationId: ...                 â”‚
â”‚ departmentId: ...                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Permission Matrix (Simple View)

```
                        Roles
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
Permissions      â”‚Enterpriseâ”‚  Super   â”‚ Admin  â”‚  Branch  â”‚  User  â”‚
                 â”‚  Admin   â”‚  Admin   â”‚        â”‚  Admin   â”‚        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ USER_CREATE    â”‚    âœ…    â”‚    âœ…    â”‚   âœ…   â”‚    âŒ    â”‚   âŒ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ USER_READ      â”‚    âœ…    â”‚    âœ…    â”‚   âœ…   â”‚    âœ…    â”‚   âŒ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ USER_DELETE    â”‚    âœ…    â”‚    âŒ    â”‚   âŒ   â”‚    âŒ    â”‚   âŒ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ASSET_ASSIGN   â”‚    âœ…    â”‚    âœ…    â”‚   âœ…   â”‚    âœ…    â”‚   âŒ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ASSET_DELETE   â”‚    âœ…    â”‚    âŒ    â”‚   âŒ   â”‚    âŒ    â”‚   âŒ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ REPORT_VIEW    â”‚    âœ…    â”‚    âœ…    â”‚   âœ…   â”‚    âœ…    â”‚   âœ…   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ REPORT_GENERAT â”‚    âœ…    â”‚    âœ…    â”‚   âœ…   â”‚    âŒ    â”‚   âŒ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚SETTINGS_MANAGE â”‚    âœ…    â”‚    âŒ    â”‚   âŒ   â”‚    âŒ    â”‚   âŒ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ­ Scope-Based Access (à¤…à¤²à¤—-à¤…à¤²à¤— Roles à¤¦à¥‡à¤– à¤¸à¤•à¤¤à¥‡ à¤¹à¥ˆà¤‚)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ORGANIZATION                                â”‚
â”‚  (Company XYZ)                                           â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ENTERPRISE ADMIN                                 â”‚   â”‚
â”‚  â”‚ Can see ALL users everywhere                     â”‚   â”‚
â”‚  â”‚ â”œâ”€ Mumbai Branch - All users                     â”‚   â”‚
â”‚  â”‚ â”œâ”€ Delhi Branch - All users                      â”‚   â”‚
â”‚  â”‚ â””â”€ Sales Dept - All users                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ SUPER ADMIN                                      â”‚   â”‚
â”‚  â”‚ Can see only organization users                  â”‚   â”‚
â”‚  â”‚ â”œâ”€ Mumbai Branch - All users                     â”‚   â”‚
â”‚  â”‚ â”œâ”€ Delhi Branch - All users                      â”‚   â”‚
â”‚  â”‚ â””â”€ Sales Dept - All users                        â”‚   â”‚
â”‚  â”‚ (Different org = Cannot see)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â”‚
â”‚  â”‚ADMIN         â”‚  â”‚ADMIN         â”‚                 â”‚   â”‚
â”‚  â”‚(Sales Dept)  â”‚  â”‚(IT Dept)     â”‚                 â”‚   â”‚
â”‚  â”‚              â”‚  â”‚              â”‚                 â”‚   â”‚
â”‚  â”‚Can see only  â”‚  â”‚Can see only  â”‚                 â”‚   â”‚
â”‚  â”‚dept users    â”‚  â”‚dept users    â”‚                 â”‚   â”‚
â”‚  â”‚ â””â”€ Sales    â”‚  â”‚ â””â”€ IT         â”‚                 â”‚   â”‚
â”‚  â”‚   Users      â”‚  â”‚   Users      â”‚                 â”‚   â”‚
â”‚  â”‚ (IT dept =   â”‚  â”‚ (Sales dept  â”‚                 â”‚   â”‚
â”‚  â”‚ Cannot see)  â”‚  â”‚ = Cannot see)â”‚                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Authentication + Authorization Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USER LOGS IN                                         â”‚
â”‚    POST /api/auth/login                                 â”‚
â”‚    {email: "john@example.com", password: "..."}         â”‚
â”‚                                                         â”‚
â”‚    âœ… verify password from userLogin model              â”‚
â”‚    âœ… Create JWT token                                  â”‚
â”‚    âœ… return token                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. CLIENT MAKES REQUEST WITH TOKEN                      â”‚
â”‚    GET /api/users                                       â”‚
â”‚    Headers: {Authorization: "Bearer <token>"}           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. AUTHENTICATION (Is the user who they say they are?)  â”‚
â”‚    verifyJWT middleware                                 â”‚
â”‚                                                         â”‚
â”‚    âœ… Decode JWT                                        â”‚
â”‚    âœ… Verify signature                                  â”‚
â”‚    âœ… Set req.user = {_id, email, roleId...}           â”‚
â”‚    âœ… Continue                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. AUTHORIZATION (Can they do what they're asking?)     â”‚
â”‚    authorize middleware                                 â”‚
â”‚                                                         â”‚
â”‚    âœ… Get req.user.roleId                               â”‚
â”‚    âœ… Find Role in database                             â”‚
â”‚    âœ… Check permission exists                           â”‚
â”‚    âœ… Set req.userRole = {name, permissions...}         â”‚
â”‚    âœ… Continue to controller                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. CONTROLLER LOGIC                                     â”‚
â”‚                                                         â”‚
â”‚    âœ… Get users based on scope                          â”‚
â”‚    âœ… Enterprise Admin â†’ All users                      â”‚
â”‚    âœ… Super Admin â†’ Org users                           â”‚
â”‚    âœ… Admin â†’ Dept users                                â”‚
â”‚    âœ… Regular User â†’ Only themselves                    â”‚
â”‚    âœ… Return filtered results                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. RESPONSE                                             â”‚
â”‚    200 OK                                               â”‚
â”‚    [                                                    â”‚
â”‚      {id: "123", name: "John", ...},                   â”‚
â”‚      {id: "456", name: "Jane", ...}                    â”‚
â”‚    ]                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Permission Checking Methods

```
4 Ways to Check Permissions:

1. authorize('PERMISSION_CODE')
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Checks: User has AT LEAST ONE of the permissions
   Example: authorize('USER_CREATE')
   Usage: POST /users
   
   router.post('/users', 
     verifyJWT,
     authorize('USER_CREATE'),
     controller
   );


2. requireAllPermissions('PERM1', 'PERM2')
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Checks: User has ALL the permissions
   Example: requireAllPermissions('USER_UPDATE', 'USER_PERMISSIONS')
   Usage: PATCH /users/:id/permissions
   
   router.patch('/users/:id/permissions',
     verifyJWT,
     requireAllPermissions('USER_UPDATE', 'USER_PERMISSIONS'),
     controller
   );


3. hasRole('ROLE_CODE1', 'ROLE_CODE2')
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Checks: User's role code matches
   Example: hasRole('ROLE_ENTERPRISE_ADMIN', 'ROLE_SUPER_ADMIN')
   Usage: DELETE /users/:id
   
   router.delete('/users/:id',
     verifyJWT,
     hasRole('ROLE_ENTERPRISE_ADMIN', 'ROLE_SUPER_ADMIN'),
     controller
   );


4. Manual check in controller
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Checks: Anything your logic needs
   Example: role.level >= 4
   
   const canDelete = req.userRole.level >= 4;
   if (!canDelete) throw new ApiError(403, 'Access denied');
```

---

## ğŸ¯ Decision Tree: Which Method to Use?

```
Question: How do I protect this route?
                 â”‚
                 â–¼
        Is it permission-based?
       (can multiple roles do it?)
        /                 \
       YES                NO
      â”‚                    â”‚
      â–¼                    â–¼
Use authorize()    Is it strict role-based?
                   (only 1-2 specific roles?)
                    /            \
                   YES            NO
                  â”‚                â”‚
                  â–¼                â–¼
            Use hasRole()    Manual check in
                             controller logic
                             (check role.level
                              or custom logic)


Example:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
USER_CREATE â†’ authorize('USER_CREATE')
DELETE USER â†’ hasRole('ROLE_ENTERPRISE_ADMIN')
CHANGE ROLE â†’ requireAllPermissions('USER_UPDATE', 'USER_PERMISSIONS')
CUSTOM_LOGIC â†’ Manual check: if (role.level < 3) throw error
```

---

## ğŸ§ª Testing Each Method

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST 1: authorize() - Multiple roles can use         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ Route: POST /api/users                              â”‚
â”‚ Middleware: authorize('USER_CREATE')                â”‚
â”‚                                                      â”‚
â”‚ Test Cases:                                          â”‚
â”‚ â”œâ”€ Enterprise Admin (has permission) â†’ âœ… 201       â”‚
â”‚ â”œâ”€ Super Admin (has permission) â†’ âœ… 201           â”‚
â”‚ â”œâ”€ Admin (has permission) â†’ âœ… 201                 â”‚
â”‚ â”œâ”€ Branch Admin (NO permission) â†’ âŒ 403           â”‚
â”‚ â””â”€ User (NO permission) â†’ âŒ 403                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST 2: hasRole() - Only specific roles allowed      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ Route: DELETE /api/users/:id                        â”‚
â”‚ Middleware: hasRole('ROLE_ENTERPRISE_ADMIN',        â”‚
â”‚                     'ROLE_SUPER_ADMIN')             â”‚
â”‚                                                      â”‚
â”‚ Test Cases:                                          â”‚
â”‚ â”œâ”€ Enterprise Admin â†’ âœ… 200                        â”‚
â”‚ â”œâ”€ Super Admin â†’ âœ… 200                             â”‚
â”‚ â”œâ”€ Admin (not in list) â†’ âŒ 403                     â”‚
â”‚ â”œâ”€ Branch Admin â†’ âŒ 403                            â”‚
â”‚ â””â”€ User â†’ âŒ 403                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TEST 3: Manual check in controller                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚ Code: if (req.userRole.level < 4) throw error      â”‚
â”‚                                                      â”‚
â”‚ Test Cases:                                          â”‚
â”‚ â”œâ”€ Enterprise Admin (level 5) â†’ âœ… Pass            â”‚
â”‚ â”œâ”€ Super Admin (level 4) â†’ âœ… Pass                 â”‚
â”‚ â”œâ”€ Admin (level 3) â†’ âŒ Fail                       â”‚
â”‚ â”œâ”€ Branch Admin (level 2) â†’ âŒ Fail                â”‚
â”‚ â””â”€ User (level 1) â†’ âŒ Fail                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USER      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â†’ Assigned ONE Role (roleId)
       â”‚
       â”‚   Role contains:
       â”‚   â”œâ”€ Name (e.g. "Enterprise Admin")
       â”‚   â”œâ”€ Code (e.g. "ROLE_ENTERPRISE_ADMIN")
       â”‚   â”œâ”€ Level (e.g. 5 = highest)
       â”‚   â””â”€ Permissions array [USER_CREATE, USER_DELETE, ...]
       â”‚
       â”œâ”€â†’ When user makes request:
       â”‚   1. Auth: Verify JWT âœ…
       â”‚   2. Auth: Get user's roleId âœ…
       â”‚   3. Check: Role has required permission? âœ…
       â”‚   4. If NO: Return 403 âŒ
       â”‚   5. If YES: Proceed to controller âœ…
       â”‚
       â””â”€â†’ Controller can then:
           â”œâ”€ Apply scope restrictions
           â”œâ”€ Validate business logic
           â””â”€ Return 200 OK âœ…
```

---

**That's it! à¤…à¤¬ à¤¤à¥à¤®à¥à¤¹à¥‡à¤‚ à¤¸à¤®à¤ à¤† à¤—à¤¯à¤¾ à¤¹à¥‹à¤—à¤¾ à¤•à¤¿ permission system à¤•à¥ˆà¤¸à¥‡ à¤•à¤¾à¤® à¤•à¤°à¤¤à¤¾ à¤¹à¥ˆ! ğŸ‰**
